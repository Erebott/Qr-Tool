<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QR Tool (iOS-friendly + Torch)</title>

  <!-- Html5-Qrcode (HTTPS CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 16px; }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin: 8px 0; }
    select, button, input[type="file"] { padding:8px; border-radius:10px; border: 1px solid #9993; }
    button { cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    #scanner { width: 100%; max-width: 420px; aspect-ratio: 1 / 1; background: #00000010; border-radius: 12px; overflow:hidden; }
    #scanStatus { margin: 8px 0; min-height: 20px; }
    .success { color: #128a12; }
    .danger { color: #c62828; }
    .pill { font-size:.85rem; padding:.25rem .5rem; border-radius:999px; background:#9992; }
    textarea { width: 100%; max-width: 420px; height: 72px; border-radius:10px; padding:10px; }
    .hint { opacity:.7; font-size:.9rem; }
  </style>
</head>
<body>
  <h1>QR Tool</h1>

  <div class="row">
    <label for="cameraSelect" class="pill">Camera</label>
    <select id="cameraSelect"></select>

    <button id="btnStart">Start</button>
    <button id="btnStop" disabled>Stop</button>

    <!-- Torch (appears only if supported) -->
    <button id="btnTorch" hidden>üî¶ Torch</button>
  </div>

  <div id="scanner"></div>

  <div id="scanStatus" class="hint">Ready.</div>

  <div class="row">
    <input id="fileInput" type="file" accept="image/*" />
    <span class="hint">‚Ä¶or pick an image to scan</span>
  </div>

  <textarea id="scanResult" placeholder="Decoded text will appear here‚Ä¶" readonly></textarea>

  <script>
    // --- helpers ---
    const byId = (id) => document.getElementById(id);

    let html5Qrcode = null;
    let currentCameraId = null;
    let torchOn = false;

    function isSecureOrigin(){
      return location.protocol === 'https:' || location.hostname === 'localhost';
    }

    async function listCameras() {
      const sel = byId('cameraSelect');
      sel.innerHTML = '';
      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || !devices.length) {
          sel.innerHTML = '<option value="">No cameras</option>';
          return;
        }
        devices.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.label || `Camera ${i + 1}`;
          sel.appendChild(opt);
        });
        currentCameraId = devices[0].id;
        sel.value = currentCameraId;
      } catch (err) {
        byId('scanStatus').innerHTML = `‚ö†Ô∏è Cameras not available: <span class="danger">${err}</span>`;
      }
    }

    function onScanSuccess(decodedText /*, decodedResult */) {
      byId('scanResult').value = decodedText || '';
      byId('scanStatus').innerHTML = '<span class="success">QR detected.</span>';
      // optional: stop after first scan
      // stopScanner();
    }

    function onScanFail(/* error */) {
      // called for each frame decode fail; keep quiet to avoid noise
    }

    async function startScanner() {
      if (!isSecureOrigin()) {
        byId('scanStatus').innerHTML = '‚ö†Ô∏è iOS requires HTTPS (or localhost) for camera.';
        return;
      }

      const elId = 'scanner';
      if (!html5Qrcode) html5Qrcode = new Html5Qrcode(elId);

      byId('btnStart').disabled = true;
      byId('btnStop').disabled = false;
      byId('scanStatus').textContent = 'Starting camera‚Ä¶';

      const config = { fps: 10, qrbox: { width: 240, height: 240 }, aspectRatio: 1.0 };

      // Hide torch UI until we know it‚Äôs supported.
      byId('btnTorch').hidden = true;
      torchOn = false;

      try {
        // iOS-friendly first: request the back camera without deviceId.
        await html5Qrcode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFail);

        // After permission, deviceIds/labels are available on iOS; refresh list.
        listCameras().catch(() => {});

        byId('scanStatus').textContent = 'Camera running.';
        await maybeEnableTorchButton(); // show torch button if supported
      } catch (e1) {
        // Fallback: try using the selected deviceId (good on desktop/Android).
        try {
          const camId = byId('cameraSelect').value || currentCameraId;
          if (!camId) throw e1;
          await html5Qrcode.start(camId, config, onScanSuccess, onScanFail);
          byId('scanStatus').textContent = 'Camera running.';
          await maybeEnableTorchButton();
        } catch (e2) {
          byId('scanStatus').innerHTML =
            `‚ö†Ô∏è Camera start failed: <span class="danger">${e2.message || e2}</span>`;
          byId('btnStart').disabled = false;
          byId('btnStop').disabled = true;
        }
      }
    }

    async function stopScanner() {
      try {
        if (html5Qrcode && html5Qrcode.isScanning) await html5Qrcode.stop();
        byId('scanStatus').textContent = 'Stopped.';
      } catch (e) {
        byId('scanStatus').innerHTML = `‚ö†Ô∏è Stop error: <span class="danger">${e.message || e}</span>`;
      } finally {
        byId('btnStart').disabled = false;
        byId('btnStop').disabled = true;
        byId('btnTorch').hidden = true;
        torchOn = false;
      }
    }

    // --- Torch support (if the running track supports it) ---
    async function maybeEnableTorchButton() {
      try {
        // Ask the scanner for the running track‚Äôs capabilities.
        const caps = html5Qrcode.getRunningTrackCapabilities();
        if (caps && 'torch' in caps) {
          byId('btnTorch').hidden = false;
          byId('btnTorch').textContent = 'üî¶ Torch: Off';
        } else {
          byId('btnTorch').hidden = true;
        }
      } catch {
        byId('btnTorch').hidden = true;
      }
    }

    async function toggleTorch() {
      if (!html5Qrcode || !html5Qrcode.isScanning) return;
      try {
        torchOn = !torchOn;
        // Apply the constraint to the running video track.
        await html5Qrcode.applyVideoConstraints({ advanced: [{ torch: torchOn }] });
        byId('btnTorch').textContent = torchOn ? 'üî¶ Torch: On' : 'üî¶ Torch: Off';
      } catch (e) {
        byId('scanStatus').innerHTML =
          `‚ö†Ô∏è Torch not available: <span class="danger">${e.message || e}</span>`;
        byId('btnTorch').hidden = true;
        torchOn = false;
      }
    }

    // --- File scan (avoid double instances) ---
    async function scanFromFile(file) {
      // stop live scan if active to avoid conflicts
      try { if (html5Qrcode && html5Qrcode.isScanning) await html5Qrcode.stop(); } catch {}
      byId('btnStart').disabled = false;
      byId('btnStop').disabled = true;
      byId('btnTorch').hidden = true;
      torchOn = false;

      try {
        const decoder = new Html5Qrcode('scanner');
        try {
          const result = await decoder.scanFileV2(file, true);
          byId('scanResult').value = result.decodedText;
          byId('scanStatus').innerHTML = '<span class="success">Image decoded.</span>';
        } catch {
          byId('scanStatus').innerHTML = '‚ö†Ô∏è No QR found in image.';
        } finally {
          try { await decoder.clear(); } catch {}
        }
      } catch (err) {
        byId('scanStatus').innerHTML = `Error reading file: <span class="danger">${err}</span>`;
      }
    }

    // --- init ---
    (function init(){
      // Non-blocking camera list (on iOS, labels appear after permission)
      listCameras().catch(()=>{});

      byId('cameraSelect').addEventListener('change', (e)=> currentCameraId = e.target.value);
      byId('btnStart').addEventListener('click', startScanner);
      byId('btnStop').addEventListener('click', stopScanner);
      byId('btnTorch').addEventListener('click', toggleTorch);
      byId('fileInput').addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if (f) scanFromFile(f);
      });
    })();
  </script>
</body>
</html>
