<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QR Scanner + Variant Generator</title>

  <!-- Html5-Qrcode (camera scanning) -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>
  <!-- QRCode generator (for creating QR images) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    h1 { font-size: 1.2rem; margin: 0 0 10px; }
    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin: 8px 0; }
    button, select, input, textarea { border: 1px solid #9993; border-radius: 10px; padding: 8px 10px; }
    button { cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    #scanner { width: 100%; max-width: 460px; aspect-ratio: 1 / 1; background: #00000010; border-radius: 12px; overflow: hidden; }
    #scanStatus { min-height: 22px; margin: 6px 0; font-size: .95rem; opacity: .9; }
    .success { color: #128a12; }
    .danger { color: #c62828; }
    textarea { width: 100%; max-width: 460px; height: 80px; }
    .section { margin-top: 16px; padding-top: 8px; border-top: 1px dashed #aaa4; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
    .card { border: 1px solid #9993; border-radius: 12px; padding: 10px; }
    .qrbox { width: 100%; height: 160px; display: grid; place-items: center; }
    .muted { opacity: .7; font-size: .9rem; }
    .grow { flex: 1 1 auto; }
    label.small { font-size: .85rem; opacity: .8; }
  </style>
</head>
<body>
  <h1>QR Scanner + Variant Generator</h1>

  <!-- Controls Row -->
  <div class="row">
    <label class="small" for="cameraSelect">Camera</label>
    <select id="cameraSelect"></select>

    <button id="btnStart">Start</button>
    <button id="btnStop" disabled>Stop</button>

    <button id="btnTorch" hidden>üî¶ Torch: Off</button>

    <div id="zoomWrap" class="row" hidden>
      <label class="small" for="zoomRange">Zoom</label>
      <input id="zoomRange" type="range" min="1" max="1" step="0.1" value="1" />
      <span id="zoomVal" class="small muted">1√ó</span>
    </div>
  </div>

  <!-- Scanner View -->
  <div id="scanner"></div>
  <div id="scanStatus" class="muted">Ready.</div>

  <div class="row">
    <input id="fileInput" type="file" accept="image/*" />
    <span class="muted">‚Ä¶or select an image to scan</span>
  </div>

  <!-- Decoded Output -->
  <div class="section">
    <label class="small" for="scanResult">Decoded Text</label>
    <textarea id="scanResult" placeholder="Decoded text will appear here‚Ä¶" readonly></textarea>
  </div>

  <!-- Variant Generator -->
  <div class="section">
    <div class="row">
      <div class="grow">
        <label class="small" for="baseText">Base Text (defaults to decoded text)</label>
        <input id="baseText" type="text" placeholder="e.g. ABC12345" style="width:100%;" />
      </div>
      <button id="btnMakeVariants">Generate 10 Variants</button>
    </div>
    <div class="muted" style="margin-top:-4px">Will increment the <b>last letter or digit</b> by +1 repeatedly (wraps 9‚Üí0, Z‚ÜíA, z‚Üía). If no alphanumeric at the end, generation will fail.</div>

    <div id="variants" class="grid" style="margin-top:12px;"></div>
  </div>

  <script>
    // ========= Helpers =========
    const $ = (id) => document.getElementById(id);
    let html5Qrcode = null;
    let currentCameraId = null;
    let torchOn = false;
    let hasZoom = false;

    function isSecureOrigin(){
      return location.protocol === 'https:' || location.hostname === 'localhost';
    }

    async function listCameras(){
      const sel = $('cameraSelect');
      sel.innerHTML = '';
      try{
        const devices = await Html5Qrcode.getCameras();
        if(!devices?.length){ sel.innerHTML = '<option value="">No cameras</option>'; return; }
        for(let i=0;i<devices.length;i++){
          const d = devices[i];
          const opt = document.createElement('option');
          opt.value = d.id; opt.textContent = d.label || `Camera ${i+1}`;
          sel.appendChild(opt);
        }
        currentCameraId = devices[0].id; sel.value = currentCameraId;
      }catch(err){
        $('scanStatus').innerHTML = `‚ö†Ô∏è Cameras not available: <span class="danger">${err}</span>`;
      }
    }

    function onScanSuccess(decodedText){
      $('scanResult').value = decodedText || '';
      if(!$('baseText').value) $('baseText').value = decodedText || '';
      $('scanStatus').innerHTML = '<span class="success">QR detected.</span>';
    }

    function onScanFail(){ /* ignore frame decode errors to avoid noise */ }

    async function startScanner(){
      if(!isSecureOrigin()){
        $('scanStatus').innerHTML = '‚ö†Ô∏è iOS requires HTTPS (or localhost) for camera access.';
        return;
      }
      if(!html5Qrcode) html5Qrcode = new Html5Qrcode('scanner');

      $('btnStart').disabled = true; $('btnStop').disabled = false; $('scanStatus').textContent = 'Starting camera‚Ä¶';
      $('btnTorch').hidden = true; torchOn = false; $('zoomWrap').hidden = true; hasZoom = false;

      const cfg = { fps: 10, qrbox: { width: 260, height: 260 }, aspectRatio: 1.0 };
      try{
        // iOS-friendly: start with facingMode first
        await html5Qrcode.start({ facingMode: 'environment' }, cfg, onScanSuccess, onScanFail);
        listCameras().catch(()=>{});
        $('scanStatus').textContent = 'Camera running.';
        await revealTrackFeaturesIfAny();
      }catch(e1){
        try{
          const camId = $('cameraSelect').value || currentCameraId;
          if(!camId) throw e1;
          await html5Qrcode.start(camId, cfg, onScanSuccess, onScanFail);
          $('scanStatus').textContent = 'Camera running.';
          await revealTrackFeaturesIfAny();
        }catch(e2){
          $('scanStatus').innerHTML = `‚ö†Ô∏è Camera start failed: <span class="danger">${e2.message || e2}</span>`;
          $('btnStart').disabled = false; $('btnStop').disabled = true;
        }
      }
    }

    async function stopScanner(){
      try{
        if(html5Qrcode?.isScanning) await html5Qrcode.stop();
        $('scanStatus').textContent = 'Stopped.';
      }catch(e){
        $('scanStatus').innerHTML = `‚ö†Ô∏è Stop error: <span class="danger">${e.message || e}</span>`;
      }finally{
        $('btnStart').disabled = false; $('btnStop').disabled = true;
        $('btnTorch').hidden = true; torchOn = false; $('zoomWrap').hidden = true; hasZoom = false;
      }
    }

    // ======= Torch & Zoom =======
    async function revealTrackFeaturesIfAny(){
      try{
        const caps = html5Qrcode.getRunningTrackCapabilities?.();
        if(!caps) return;
        // Torch
        if('torch' in caps){ $('btnTorch').hidden = false; $('btnTorch').textContent = 'üî¶ Torch: Off'; }
        else { $('btnTorch').hidden = true; }
        // Zoom
        if('zoom' in caps){
          let min = 1, max = 1, step = 0.1;
          try{ min = caps.zoom.min ?? 1; max = caps.zoom.max ?? 1; step = caps.zoom.step ?? 0.1; }catch{}
          if(max > min){
            const r = $('zoomRange');
            r.min = String(min); r.max = String(max); r.step = String(step); r.value = String(min);
            $('zoomVal').textContent = `${Number(r.value).toFixed(1)}√ó`;
            $('zoomWrap').hidden = false; hasZoom = true;
          }
        } else {
          $('zoomWrap').hidden = true; hasZoom = false;
        }
      }catch{}
    }

    async function toggleTorch(){
      if(!html5Qrcode?.isScanning) return;
      try{
        torchOn = !torchOn;
        await html5Qrcode.applyVideoConstraints({ advanced: [{ torch: torchOn }] });
        $('btnTorch').textContent = torchOn ? 'üî¶ Torch: On' : 'üî¶ Torch: Off';
      }catch(e){
        $('scanStatus').innerHTML = `‚ö†Ô∏è Torch not available: <span class=\"danger\">${e.message || e}</span>`;
        $('btnTorch').hidden = true; torchOn = false;
      }
    }

    async function setZoom(val){
      if(!html5Qrcode?.isScanning || !hasZoom) return;
      try{
        await html5Qrcode.applyVideoConstraints({ advanced: [{ zoom: Number(val) }] });
        $('zoomVal').textContent = `${Number(val).toFixed(1)}√ó`;
      }catch(e){ $('scanStatus').innerHTML = `‚ö†Ô∏è Zoom failed: <span class=\"danger\">${e.message || e}</span>`; }
    }

    // ======= File scan (avoid double instances) =======
    async function scanFromFile(file){
      try{ if(html5Qrcode?.isScanning) await html5Qrcode.stop(); }catch{}
      $('btnStart').disabled = false; $('btnStop').disabled = true; $('btnTorch').hidden = true; $('zoomWrap').hidden = true;

      try{
        const decoder = new Html5Qrcode('scanner');
        try{
          const result = await decoder.scanFileV2(file, true);
          $('scanResult').value = result.decodedText || '';
          if(!$('baseText').value) $('baseText').value = result.decodedText || '';
          $('scanStatus').innerHTML = '<span class="success">Image decoded.</span>';
        }catch{ $('scanStatus').innerHTML = '‚ö†Ô∏è No QR found in image.'; }
        finally{ try{ await decoder.clear(); }catch{} }
      }catch(err){ $('scanStatus').innerHTML = `Error reading file: <span class="danger">${err}</span>`; }
    }

    // ======= Variant generation =======
    function isAlphaNum(ch){ return /[0-9A-Za-z]/.test(ch); }
    function incOne(ch){
      if(ch >= '0' && ch <= '8') return String.fromCharCode(ch.charCodeAt(0)+1);
      if(ch === '9') return '0';
      if(ch >= 'A' && ch <= 'Y') return String.fromCharCode(ch.charCodeAt(0)+1);
      if(ch === 'Z') return 'A';
      if(ch >= 'a' && ch <= 'y') return String.fromCharCode(ch.charCodeAt(0)+1);
      if(ch === 'z') return 'a';
      return ch;
    }
    function incCharBy(ch, k){ let c = ch; for(let i=0;i<k;i++) c = incOne(c); return c; }

    function makeVariants(){
      const baseInput = $('baseText').value || $('scanResult').value || '';
      if(!baseInput){ $('scanStatus').innerHTML = '‚ö†Ô∏è Nothing to generate. Provide base text.'; return; }
      // find last alphanumeric character
      let idx = -1;
      for(let i = baseInput.length - 1; i >= 0; i--){ if(isAlphaNum(baseInput[i])){ idx = i; break; } }
      if(idx === -1){ $('scanStatus').innerHTML = '‚ö†Ô∏è Base text must end with a letter or digit.'; return; }

      const list = [];
      for(let i=1;i<=10;i++){
        const ch = baseInput[idx];
        const inc = incCharBy(ch, i);
        list.push(baseInput.slice(0, idx) + inc + baseInput.slice(idx+1));
      }

      renderVariants(list);
    }

    function renderVariants(arr){
      const wrap = $('variants');
      wrap.innerHTML = '';
      arr.forEach((text, i)=>{
        const card = document.createElement('div');
        card.className = 'card';
        const box = document.createElement('div'); box.className = 'qrbox';
        const label = document.createElement('div'); label.className = 'muted'; label.textContent = text;
        const actions = document.createElement('div'); actions.className = 'row';
        const btn = document.createElement('button'); btn.textContent = 'Download PNG';

        const qrDiv = document.createElement('div'); box.appendChild(qrDiv);
        new QRCode(qrDiv, { text, width: 150, height: 150, correctLevel: QRCode.CorrectLevel.M });

        btn.addEventListener('click', ()=>{
          const canvas = qrDiv.querySelector('canvas');
          if(!canvas) return;
          const link = document.createElement('a');
          link.download = `qr_variant_${i+1}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        });

        actions.appendChild(btn);
        card.appendChild(box);
        card.appendChild(label);
        card.appendChild(actions);
        wrap.appendChild(card);
      });
    }

    // ======= init =======
    (function init(){
      listCameras().catch(()=>{});
      $('cameraSelect').addEventListener('change', (e)=> currentCameraId = e.target.value);
      $('btnStart').addEventListener('click', startScanner);
      $('btnStop').addEventListener('click', stopScanner);
      $('btnTorch').addEventListener('click', toggleTorch);
      $('zoomRange').addEventListener('input', (e)=> setZoom(e.target.value));
      $('fileInput').addEventListener('change', (e)=>{ const f = e.target.files?.[0]; if(f) scanFromFile(f); });
      $('btnMakeVariants').addEventListener('click', makeVariants);
    })();
  </script>
</body>
</html>
