<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Code Reader & Generator – Single File</title>
  <style>
    :root { --bg:#0b1020; --card:#121931; --muted:#9fb0ff; --text:#e8ecff; --accent:#6ea8fe; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0e1530 50%,#0b1020);color:var(--text)}
    header{padding:20px 24px;border-bottom:1px solid #1c2444;background:rgba(10,15,35,.6);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
    h1{font-size:clamp(20px,2.6vw,28px);margin:0 0 6px}
    .sub{opacity:.75}
    main{padding:20px;max-width:1200px;margin:0 auto}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    @media (max-width:900px){.col-6{grid-column:span 12}}
    .card{background:var(--card);border:1px solid #1c2444;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px}
    .card h2{margin:0 0 12px;font-size:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input[type="text"], textarea, select{width:100%;background:#0d1430;border:1px solid #26305a;color:var(--text);border-radius:10px;padding:10px 12px}
    textarea{min-height:84px;resize:vertical}
    button{background:linear-gradient(180deg,#3a66ff,#365df0);color:#fff;border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid #2a3970}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .qr-wrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px}
    .qr-card{background:#0f1734;border:1px solid #26305a;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .qr-canvas{align-self:center;background:#fff;border-radius:8px;padding:6px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#0d1430;border:1px solid #223160;font-size:12px}
    .footer{opacity:.7;font-size:12px;margin-top:20px}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .danger{color:#ff8080}
    .success{color:#81ffb0}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
  <!-- QR Scan & Generate libs (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.9/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
  <header>
    <h1>QR Code Reader & Generator</h1>
    <div class="sub">Scanne einen QR, erstelle daraus einen neuen – und generiere Varianten (z. B. letzte Ziffer 0–9).</div>
  </header>
  <main>
    <div class="grid">
      <!-- Scanner -->
      <section class="card col-6">
        <h2>1) QR-Code scannen</h2>
        <div class="row" style="gap:10px;margin-bottom:10px">
          <select id="cameraSelect" title="Kamera"></select>
          <button id="btnStart">Kamera starten</button>
          <button id="btnStop" class="ghost" disabled>Stop</button>
        </div>
        <div id="scanner" style="width:100%;max-width:520px;aspect-ratio:1;border-radius:12px;overflow:hidden"></div>
        <div style="margin:10px 0" class="muted">Oder lade ein Bild hoch:</div>
        <input type="file" id="fileInput" accept="image/*" />
        <div id="scanStatus" class="muted">Bereit.</div>
        <div style="margin-top:10px">
          <label class="muted">Erkanntes Ergebnis</label>
          <textarea id="scanResult" placeholder="Hier erscheint der gescannte Text"></textarea>
          <div class="row">
            <button id="useScanned">In Generator übernehmen</button>
            <span class="pill"><span>Auto‑Stop bei Treffer</span><input id="autoStop" type="checkbox" checked/></span>
          </div>
        </div>
      </section>

      <!-- Generator -->
      <section class="card col-6">
        <h2>2) QR-Code generieren</h2>
        <label class="muted">Inhalt</label>
        <textarea id="genInput" placeholder="Text/URL für QR-Code"></textarea>
        <div class="row" style="margin-top:8px">
          <select id="ecc">
            <option value="L">ECC L (7%)</option>
            <option value="M" selected>ECC M (15%)</option>
            <option value="Q">ECC Q (25%)</option>
            <option value="H">ECC H (30%)</option>
          </select>
          <select id="size">
            <option value="160">Größe 160px</option>
            <option value="256" selected>Größe 256px</option>
            <option value="384">Größe 384px</option>
            <option value="512">Größe 512px</option>
          </select>
          <button id="btnGenerate">QR erzeugen</button>
        </div>
        <div id="qrOutput" class="qr-canvas" style="margin-top:10px"></div>
        <div class="row">
          <button id="btnDownload" class="ghost" disabled>PNG herunterladen</button>
          <button id="btnCopy" class="ghost" disabled>Bild kopieren</button>
        </div>
      </section>

      <!-- Varianten -->
      <section class="card col-12">
        <h2>3) Varianten automatisch erzeugen (Suffix‑Ziffern)</h2>
        <div class="muted" style="margin-bottom:8px">
          Nimmt den eingegebenen Text und ersetzt die <b>letzte Ziffer</b> systematisch mit 0–9. Ideal z. B. für Codes mit laufender Endziffer.
        </div>
        <div class="row">
          <button id="btnVariants10">10 Varianten (0–9) erzeugen</button>
          <button id="btnVariantsInc" class="ghost">Suffix um +1 erhöhen</button>
          <button id="btnVariantsDec" class="ghost">Suffix um −1 verringern</button>
        </div>
        <div id="variantInfo" class="muted" style="margin-top:8px"></div>
        <div id="variants" class="qr-wrap" style="margin-top:10px"></div>
      </section>

      <section class="card col-12">
        <h2>Hinweise & Datenschutz</h2>
        <ul>
          <li>Kamera-Zugriff bleibt im Browser; es werden keine Daten hochgeladen.</li>
          <li>Bild‑Upload wird lokal im Tab verarbeitet.</li>
          <li>Für maximalen Kontrast sind QR‑Codes standardmäßig schwarz auf weiß.</li>
        </ul>
        <div class="footer">Erstellt als Single‑HTML. Bibliotheken: html5‑qrcode & qrcode.js (CDN).</div>
      </section>
    </div>
  </main>

  <script>
    // ===== Helpers =====
    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);

    function findNumericSuffix(str){
      const m = String(str).match(/(\d+)(?!.*\d)/); // last digit run
      if(!m) return null;
      const idx = str.lastIndexOf(m[1]);
      return { value: m[1], start: idx, end: idx + m[1].length };
    }

    function replaceLastDigitAll(str){
      const suf = findNumericSuffix(str);
      if(!suf || suf.value.length === 0) return null;
      const base = str.slice(0, suf.end - 1); // up to last digit (excluded)
      return Array.from({length:10}, (_,d)=> base + d + str.slice(suf.end));
    }

    function incDecSuffix(str, delta){
      const suf = findNumericSuffix(str);
      if(!suf) return null;
      const num = BigInt(suf.value);
      let next = num + BigInt(delta);
      if(next < 0n) next = 0n;
      const pad = suf.value.length; // keep zero‑padding
      const nextStr = next.toString().padStart(pad,'0');
      return str.slice(0, suf.start) + nextStr + str.slice(suf.end);
    }

    function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }

    function makeQRInto(container, text, size=256, ecc='M'){
      clear(container);
      const node = document.createElement('div');
      container.appendChild(node);
      /* global QRCode */
      const qr = new QRCode(node, {
        text: String(text),
        width: size,
        height: size,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel[ecc]
      });
      return qr;
    }

    function exportPngFrom(container){
      const canvas = container.querySelector('canvas');
      if(!canvas) return null;
      const url = canvas.toDataURL('image/png');
      return url;
    }

    async function copyImageFrom(container){
      const url = exportPngFrom(container);
      if(!url) return false;
      const res = await fetch(url);
      const blob = await res.blob();
      try{
        await navigator.clipboard.write([
          new ClipboardItem({ [blob.type]: blob })
        ]);
        return true;
      }catch(e){ return false; }
    }

    // ===== Scanner Setup =====
    let html5Qrcode, currentCameraId = null;

    async function listCameras(){
      try{
        const devices = await Html5Qrcode.getCameras();
        const sel = byId('cameraSelect');
        sel.innerHTML = '';
        devices.forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.id; opt.textContent = d.label || `Kamera ${i+1}`;
          sel.appendChild(opt);
        });
        if(devices[0]) currentCameraId = devices[0].id;
      }catch(err){ byId('scanStatus').innerHTML = `\u26A0\uFE0F Kameras nicht verfügbar: <span class="danger">${err}</span>`; }
    }

    async function startScanner(){
      const cameraId = byId('cameraSelect').value || currentCameraId;
      if(!cameraId) return;
      const elId = 'scanner';
      if(!html5Qrcode) html5Qrcode = new Html5Qrcode(elId);
      byId('btnStart').disabled = true; byId('btnStop').disabled = false;
      byId('scanStatus').textContent = 'Kamera läuft …';
      const config = { fps: 10, qrbox: { width: 240, height: 240 }, aspectRatio: 1.0 };
      await html5Qrcode.start(cameraId, config, onScanSuccess, onScanFail);
    }

    async function stopScanner(){
      if(html5Qrcode && html5Qrcode.isScanning){
        await html5Qrcode.stop();
      }
      byId('btnStart').disabled = false; byId('btnStop').disabled = true;
      byId('scanStatus').textContent = 'Gestoppt.';
    }

    function onScanSuccess(decodedText){
      byId('scanResult').value = decodedText;
      byId('scanStatus').innerHTML = '<span class="success">Treffer erkannt.</span>';
      if(byId('autoStop').checked) stopScanner();
    }
    function onScanFail(err){ /* optional: show nothing to avoid noise */ }

    // File upload decode via html5-qrcode
    async function scanFromFile(file){
      try{
        const reader = new FileReader();
        reader.onload = async (ev)=>{
          const dataUrl = ev.target.result;
          const tmpId = 'tmpImg';
          const img = new Image();
          img.onload = async ()=>{
            const decoder = new Html5Qrcode('scanner');
            try{
              const result = await decoder.scanFileV2(file, true);
              byId('scanResult').value = result.decodedText;
              byId('scanStatus').innerHTML = '<span class="success">Bild erkannt.</span>';
            }catch(e){
              byId('scanStatus').innerHTML = `\u26A0\uFE0F Kein QR im Bild gefunden.`;
            }finally{
              try{ await decoder.clear(); }catch(_){ }
            }
          };
          img.src = dataUrl;
        };
        reader.readAsDataURL(file);
      }catch(err){ byId('scanStatus').innerHTML = `Fehler beim Lesen: <span class="danger">${err}</span>`; }
    }

    // ===== Generator UI =====
    let currentQR = null;

    function generateMain(){
      const text = byId('genInput').value || '';
      const size = parseInt(byId('size').value,10);
      const ecc = byId('ecc').value;
      if(!text){ alert('Bitte Inhalt eingeben.'); return; }
      currentQR = makeQRInto(byId('qrOutput'), text, size, ecc);
      byId('btnDownload').disabled = false;
      byId('btnCopy').disabled = false;
    }

    function downloadMain(){
      const url = exportPngFrom(byId('qrOutput'));
      if(!url){ alert('Kein QR generiert.'); return; }
      const a = document.createElement('a');
      a.href = url; a.download = 'qr.png'; a.click();
    }

    async function copyMain(){
      const ok = await copyImageFrom(byId('qrOutput'));
      if(!ok) alert('Kopieren nicht möglich. Versuch über Rechtsklick > Kopieren.');
    }

    // ===== Variants =====
    function buildVariantCard(text){
      const card = document.createElement('div'); card.className = 'qr-card';
      const pre = document.createElement('div'); pre.className = 'code'; pre.textContent = text;
      const holder = document.createElement('div'); holder.className = 'qr-canvas';
      const row = document.createElement('div'); row.className = 'row';
      const b1 = document.createElement('button'); b1.className='ghost'; b1.textContent='PNG';
      const b2 = document.createElement('button'); b2.className='ghost'; b2.textContent='Kopieren';
      row.appendChild(b1); row.appendChild(b2);
      card.appendChild(pre); card.appendChild(holder); card.appendChild(row);
      makeQRInto(holder, text, 160, byId('ecc').value);
      b1.onclick = ()=>{ const url = exportPngFrom(holder); const a=document.createElement('a'); a.href=url; a.download = `qr_${encodeURIComponent(text).slice(0,40)}.png`; a.click(); };
      b2.onclick = ()=> copyImageFrom(holder);
      return card;
    }

    function generateVariants10(){
      const text = byId('genInput').value.trim();
      if(!text){ alert('Bitte zuerst Inhalt im Generator eingeben.'); return; }
      const arr = replaceLastDigitAll(text);
      const info = byId('variantInfo');
      const wrap = byId('variants'); clear(wrap);
      if(!arr){ info.innerHTML = 'Keine Ziffern am Ende gefunden. <span class="muted">Tipp: Hänge z. B. eine 0 an.</span>'; return; }
      info.textContent = `Ersetze letzte Ziffer systematisch (0–9). Basis: “${text}”`;
      arr.forEach(v => wrap.appendChild(buildVariantCard(v)));
    }

    function bumpVariant(delta){
      const text = byId('genInput').value.trim();
      if(!text){ alert('Bitte zuerst Inhalt im Generator eingeben.'); return; }
      const out = incDecSuffix(text, delta);
      const info = byId('variantInfo');
      const wrap = byId('variants'); clear(wrap);
      if(!out){ info.innerHTML = 'Kein numerischer Suffix gefunden.'; return; }
      info.textContent = `Suffix ${delta>0?'+1':'-1'}: ${text} → ${out}`;
      wrap.appendChild(buildVariantCard(out));
    }

    // ===== Wire up =====
    (async function init(){
      await listCameras();
      byId('cameraSelect').addEventListener('change', e=> currentCameraId = e.target.value);
      byId('btnStart').addEventListener('click', startScanner);
      byId('btnStop').addEventListener('click', stopScanner);
      byId('fileInput').addEventListener('change', e=>{ if(e.target.files?.[0]) scanFromFile(e.target.files[0]) });
      byId('useScanned').addEventListener('click', ()=>{ byId('genInput').value = byId('scanResult').value; window.scrollTo({ top: 0, behavior:'smooth' }); });
      byId('btnGenerate').addEventListener('click', generateMain);
      byId('btnDownload').addEventListener('click', downloadMain);
      byId('btnCopy').addEventListener('click', copyMain);
      byId('btnVariants10').addEventListener('click', generateVariants10);
      byId('btnVariantsInc').addEventListener('click', ()=> bumpVariant(+1));
      byId('btnVariantsDec').addEventListener('click', ()=> bumpVariant(-1));
      // Keyboard: Ctrl+Enter generate
      byId('genInput').addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ generateMain(); } });
    })();
  </script>
</body>
</html>
