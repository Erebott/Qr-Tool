<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QR Scanner + Variant Generator</title>

  <!-- Html5-Qrcode (camera scanning) -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>
  <!-- QRCode generator (for creating QR images) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root { 
      color-scheme: dark; 
      --bg: #0b1220;            /* page background */
      --panel: #101b2e;         /* cards/panels */
      --muted: #98a7c2;         /* secondary text */
      --text: #e8f0ff;          /* primary text */
      --accent: #5aa0ff;        /* accent */
      --accent-2: #7bb6ff;      /* lighter accent */
      --danger: #ff6b6b;
      --success: #37d67a;
      --border: #2a3a56;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: rgba(0,0,0,0); }
    html, body { height: 100%; }
    body { 
      margin: 0; padding: 16px; 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      background: radial-gradient(1200px 700px at 20% -10%, #12203b 0%, transparent 60%),
                  radial-gradient(900px 600px at 120% 20%, #0e1a31 0%, transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    header { position: sticky; top: 0; z-index: 2; padding-bottom: 12px; margin: -16px -16px 12px; padding-top: env(safe-area-inset-top); background: linear-gradient(180deg, rgba(11,18,32,.95) 0%, rgba(11,18,32,.6) 100%); backdrop-filter: blur(6px); }
    .container { max-width: 640px; margin: 0 auto; padding: 12px 16px; }

    h1 { font-size: 1.1rem; margin: 0; letter-spacing: .2px; display: flex; align-items: center; gap: 8px; }
    h1 .dot { width: 8px; height: 8px; border-radius: 999px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: 0 0 12px rgba(90,160,255,.9); }

    .panel { background: linear-gradient(180deg, rgba(16,27,46,.95) 0%, rgba(16,27,46,.88) 100%); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 12px; }
    .panel + .panel { margin-top: 12px; }

    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
    .row.stretch > * { flex: 1 1 120px; }

    label.small { font-size: .85rem; color: var(--muted); }
    .muted { color: var(--muted); }

    select, input[type="text"], input[type="file"], textarea { 
      width: 100%; 
      background: #0f1a2d; color: var(--text); border: 1px solid var(--border); border-radius: 12px; 
      padding: 12px; outline: none; transition: border-color .2s, box-shadow .2s; 
    }
    select:focus, input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(90,160,255,.25); }

    .btn { 
      --grad: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      background: var(--grad); color: #071025; font-weight: 700; letter-spacing: .2px; 
      border: 0; border-radius: 14px; padding: 12px 16px; cursor: pointer; box-shadow: 0 6px 18px rgba(90,160,255,.35); 
      transition: transform .04s ease, filter .15s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { filter: grayscale(.4) brightness(.8); cursor: not-allowed; }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); box-shadow: none; }

    #scannerWrap { border-radius: 16px; overflow: hidden; border: 1px solid var(--border); }
    #scanner { width: 100%; aspect-ratio: 1 / 1; background: #0a1428; }

    #scanStatus { min-height: 22px; font-size: .95rem; }
    .success { color: var(--success); }
    .danger { color: var(--danger); }

    .zoom { display: flex; align-items: center; gap: 8px; }
    input[type="range"] { width: 160px; accent-color: var(--accent); }
    .chip { padding: 6px 10px; border-radius: 999px; background: #0f1b2e; border: 1px solid var(--border); color: var(--muted); font-size: .85rem; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
    .card { background: #0f1a2d; border: 1px solid var(--border); border-radius: 14px; padding: 10px; box-shadow: var(--shadow); }
    .qrbox { width: 100%; height: 160px; display: grid; place-items: center; background: #0b1529; border-radius: 10px; border: 1px dashed #223252; }

    @media (min-width: 540px){ h1 { font-size: 1.2rem; } }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1><span class="dot"></span> QR Scanner + Variant Generator</h1>
    </div>
  </header>

  <main class="container">
    <!-- Controls -->
    <section class="panel">
      <div class="row stretch" style="row-gap: 12px;">
        <div>
          <label class="small" for="cameraSelect">Camera</label>
          <select id="cameraSelect"></select>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" id="btnStart">Start</button>
          <button class="btn secondary" id="btnStop" disabled>Stop</button>
          <button class="btn" id="btnTorch" hidden>üî¶ Torch: Off</button>
          <div id="zoomWrap" class="zoom" hidden>
            <span class="chip">Zoom</span>
            <input id="zoomRange" type="range" min="1" max="1" step="0.1" value="1" />
            <span id="zoomVal" class="small muted">1√ó</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Scanner -->
    <section class="panel" id="scannerWrap">
      <div id="scanner"></div>
    </section>
    <div id="scanStatus" class="muted" style="padding:6px 2px;">Ready.</div>

    <section class="panel">
      <div class="row" style="align-items:center; gap:10px;">
        <input id="fileInput" type="file" accept="image/*" />
        <span class="muted">‚Ä¶or select an image to scan</span>
      </div>
    </section>

    <!-- Decoded Output -->
    <section class="panel">
      <label class="small" for="scanResult">Decoded Text</label>
      <textarea id="scanResult" placeholder="Decoded text will appear here‚Ä¶" readonly></textarea>
    </section>

    <!-- Variant Generator -->
    <section class="panel">
      <div class="row" style="row-gap:12px;">
        <div style="flex:1 1 220px;">
          <label class="small" for="baseText">Base Text (defaults to decoded text)</label>
          <input id="baseText" type="text" placeholder="e.g. ABC12345" />
        </div>
        <button class="btn" id="btnMakeVariants">Generate 10 Variants</button>
      </div>
      <p class="muted" style="margin:8px 0 0;">Increments the <b>last letter or digit</b> by +1 repeatedly (wraps 9‚Üí0, Z‚ÜíA, z‚Üía). If no alphanumeric at the end, generation will fail.</p>
      <div id="variants" class="grid" style="margin-top:12px;"></div>
    </section>
  </main>

  <script>
    // ========= Helpers =========
    const $ = (id) => document.getElementById(id);
    let html5Qrcode = null;
    let currentCameraId = null;
    let torchOn = false;
    let hasZoom = false;

    function isSecureOrigin(){
      return location.protocol === 'https:' || location.hostname === 'localhost';
    }

    async function listCameras(){
      const sel = $('cameraSelect');
      sel.innerHTML = '';
      try{
        const devices = await Html5Qrcode.getCameras();
        if(!devices?.length){ sel.innerHTML = '<option value="">No cameras</option>'; return; }
        for(let i=0;i<devices.length;i++){
          const d = devices[i];
          const opt = document.createElement('option');
          opt.value = d.id; opt.textContent = d.label || `Camera ${i+1}`;
          sel.appendChild(opt);
        }
        currentCameraId = devices[0].id; sel.value = currentCameraId;
      }catch(err){
        $('scanStatus').innerHTML = `‚ö†Ô∏è Cameras not available: <span class="danger">${err}</span>`;
      }
    }

    function onScanSuccess(decodedText){
      $('scanResult').value = decodedText || '';
      if(!$('baseText').value) $('baseText').value = decodedText || '';
      $('scanStatus').innerHTML = '<span class="success">QR detected.</span>';
    }

    function onScanFail(){ /* ignore per-frame decode errors */ }

    async function startScanner(){
      if(!isSecureOrigin()){
        $('scanStatus').innerHTML = '‚ö†Ô∏è iOS requires HTTPS (or localhost) for camera access.';
        return;
      }
      if(!html5Qrcode) html5Qrcode = new Html5Qrcode('scanner');

      $('btnStart').disabled = true; $('btnStop').disabled = false; $('scanStatus').textContent = 'Starting camera‚Ä¶';
      $('btnTorch').hidden = true; torchOn = false; $('zoomWrap').hidden = true; hasZoom = false;

      const cfg = { fps: 10, qrbox: { width: 280, height: 280 }, aspectRatio: 1.0 };
      try{
        // iOS-friendly: start with facingMode first
        await html5Qrcode.start({ facingMode: 'environment' }, cfg, onScanSuccess, onScanFail);
        listCameras().catch(()=>{});
        $('scanStatus').textContent = 'Camera running.';
        await revealTrackFeaturesIfAny();
      }catch(e1){
        try{
          const camId = $('cameraSelect').value || currentCameraId;
          if(!camId) throw e1;
          await html5Qrcode.start(camId, cfg, onScanSuccess, onScanFail);
          $('scanStatus').textContent = 'Camera running.';
          await revealTrackFeaturesIfAny();
        }catch(e2){
          $('scanStatus').innerHTML = `‚ö†Ô∏è Camera start failed: <span class="danger">${e2.message || e2}</span>`;
          $('btnStart').disabled = false; $('btnStop').disabled = true;
        }
      }
    }

    async function stopScanner(){
      try{
        if(html5Qrcode?.isScanning) await html5Qrcode.stop();
        $('scanStatus').textContent = 'Stopped.';
      }catch(e){
        $('scanStatus').innerHTML = `‚ö†Ô∏è Stop error: <span class="danger">${e.message || e}</span>`;
      }finally{
        $('btnStart').disabled = false; $('btnStop').disabled = true;
        $('btnTorch').hidden = true; torchOn = false; $('zoomWrap').hidden = true; hasZoom = false;
      }
    }

    // ======= Torch & Zoom =======
    async function revealTrackFeaturesIfAny(){
      try{
        const caps = html5Qrcode.getRunningTrackCapabilities?.();
        if(!caps) return;
        // Torch
        if('torch' in caps){ $('btnTorch').hidden = false; $('btnTorch').textContent = 'üî¶ Torch: Off'; }
        else { $('btnTorch').hidden = true; }
        // Zoom
        if('zoom' in caps){
          let min = 1, max = 1, step = 0.1;
          try{ min = caps.zoom.min ?? 1; max = caps.zoom.max ?? 1; step = caps.zoom.step ?? 0.1; }catch{}
          if(max > min){
            const r = $('zoomRange');
            r.min = String(min); r.max = String(max); r.step = String(step); r.value = String(min);
            $('zoomVal').textContent = `${Number(r.value).toFixed(1)}√ó`;
            $('zoomWrap').hidden = false; hasZoom = true;
          }
        } else {
          $('zoomWrap').hidden = true; hasZoom = false;
        }
      }catch{}
    }

    async function toggleTorch(){
      if(!html5Qrcode?.isScanning) return;
      try{
        torchOn = !torchOn;
        await html5Qrcode.applyVideoConstraints({ advanced: [{ torch: torchOn }] });
        $('btnTorch').textContent = torchOn ? 'üî¶ Torch: On' : 'üî¶ Torch: Off';
      }catch(e){
        $('scanStatus').innerHTML = `‚ö†Ô∏è Torch not available: <span class=\"danger\">${e.message || e}</span>`;
        $('btnTorch').hidden = true; torchOn = false;
      }
    }

    async function setZoom(val){
      if(!html5Qrcode?.isScanning || !hasZoom) return;
      try{
        await html5Qrcode.applyVideoConstraints({ advanced: [{ zoom: Number(val) }] });
        $('zoomVal').textContent = `${Number(val).toFixed(1)}√ó`;
      }catch(e){ $('scanStatus').innerHTML = `‚ö†Ô∏è Zoom failed: <span class=\"danger\">${e.message || e}</span>`; }
    }

    // ======= File scan (avoid double instances) =======
    async function scanFromFile(file){
      try{ if(html5Qrcode?.isScanning) await html5Qrcode.stop(); }catch{}
      $('btnStart').disabled = false; $('btnStop').disabled = true; $('btnTorch').hidden = true; $('zoomWrap').hidden = true;

      try{
        const decoder = new Html5Qrcode('scanner');
        try{
          const result = await decoder.scanFileV2(file, true);
          $('scanResult').value = result.decodedText || '';
          if(!$('baseText').value) $('baseText').value = result.decodedText || '';
          $('scanStatus').innerHTML = '<span class="success">Image decoded.</span>';
        }catch{ $('scanStatus').innerHTML = '‚ö†Ô∏è No QR found in image.'; }
        finally{ try{ await decoder.clear(); }catch{} }
      }catch(err){ $('scanStatus').innerHTML = `Error reading file: <span class="danger">${err}</span>`; }
    }

    // ======= Variant generation =======
    function isAlphaNum(ch){ return /[0-9A-Za-z]/.test(ch); }
    function incOne(ch){
      if(ch >= '0' && ch <= '8') return String.fromCharCode(ch.charCodeAt(0)+1);
      if(ch === '9') return '0';
      if(ch >= 'A' && ch <= 'Y') return String.fromCharCode(ch.charCodeAt(0)+1);
      if(ch === 'Z') return 'A';
      if(ch >= 'a' && ch <= 'y') return String.fromCharCode(ch.charCodeAt(0)+1);
      if(ch === 'z') return 'a';
      return ch;
    }
    function incCharBy(ch, k){ let c = ch; for(let i=0;i<k;i++) c = incOne(c); return c; }

    function makeVariants(){
      const baseInput = $('baseText').value || $('scanResult').value || '';
      if(!baseInput){ $('scanStatus').innerHTML = '‚ö†Ô∏è Nothing to generate. Provide base text.'; return; }
      // find last alphanumeric character
      let idx = -1;
      for(let i = baseInput.length - 1; i >= 0; i--){ if(isAlphaNum(baseInput[i])){ idx = i; break; } }
      if(idx === -1){ $('scanStatus').innerHTML = '‚ö†Ô∏è Base text must end with a letter or digit.'; return; }

      const list = [];
      for(let i=1;i<=10;i++){
        const ch = baseInput[idx];
        const inc = incCharBy(ch, i);
        list.push(baseInput.slice(0, idx) + inc + baseInput.slice(idx+1));
      }

      renderVariants(list);
    }

    function renderVariants(arr){
      const wrap = $('variants');
      wrap.innerHTML = '';
      arr.forEach((text, i)=>{
        const card = document.createElement('div');
        card.className = 'card';
        const box = document.createElement('div'); box.className = 'qrbox';
        const label = document.createElement('div'); label.className = 'muted'; label.textContent = text;
        const actions = document.createElement('div'); actions.className = 'row';
        const btn = document.createElement('button'); btn.textContent = 'Download PNG'; btn.className = 'btn';

        const qrDiv = document.createElement('div'); box.appendChild(qrDiv);
        new QRCode(qrDiv, { text, width: 140, height: 140, correctLevel: QRCode.CorrectLevel.M });

        btn.addEventListener('click', ()=>{
          const canvas = qrDiv.querySelector('canvas');
          if(!canvas) return;
          const link = document.createElement('a');
          link.download = `qr_variant_${i+1}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        });

        actions.appendChild(btn);
        card.appendChild(box);
        card.appendChild(label);
        card.appendChild(actions);
        wrap.appendChild(card);
      });
    }

    // ======= init =======
    (function init(){
      listCameras().catch(()=>{});
      $('cameraSelect').addEventListener('change', (e)=> currentCameraId = e.target.value);
      $('btnStart').addEventListener('click', startScanner);
      $('btnStop').addEventListener('click', stopScanner);
      $('btnTorch').addEventListener('click', toggleTorch);
      $('zoomRange').addEventListener('input', (e)=> setZoom(e.target.value));
      $('fileInput').addEventListener('change', (e)=>{ const f = e.target.files?.[0]; if(f) scanFromFile(f); });
      $('btnMakeVariants').addEventListener('click', makeVariants);
    })();
  </script>
</body>
</html>
